<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>File Browser</title>
	<style>
		* { margin: 0; padding: 0; box-sizing: border-box; }
		html, body { height: 100%; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; }
		body { display: flex; flex-direction: column; background: #FAFAF8; color: #3D3229; }
		#App-Header { padding: 8px 16px; background: #3D3229; color: #F5F0E8; font-size: 15px; font-weight: 600; display: flex; align-items: center; gap: 12px; }
		#App-Header-Title { display: flex; align-items: center; gap: 8px; }
		#App-Header-Title span { font-size: 18px; }
		#App-Layout-Switcher { display: flex; align-items: center; gap: 4px; margin-left: auto; }
		.pict-fb-layout-btn { background: rgba(255,255,255,0.12); border: 1px solid rgba(255,255,255,0.2); color: #F5F0E8; padding: 4px 10px; border-radius: 4px; font-size: 12px; cursor: pointer; font-family: inherit; white-space: nowrap; transition: background 0.15s; }
		.pict-fb-layout-btn:hover { background: rgba(255,255,255,0.22); }
		.pict-fb-layout-btn.active { background: #2E7D74; border-color: #2E7D74; }
		#Pict-FileBrowser-Container { flex: 1; padding: 0; overflow: hidden; }
		.pict-filebrowser { height: 100% !important; border: none !important; border-radius: 0 !important; }
	</style>
</head>
<body>
	<div id="App-Header">
		<div id="App-Header-Title">
			<span id="App-Header-Icon"></span> File Browser
		</div>
		<div id="App-Layout-Switcher"></div>
	</div>
	<div id="Pict-FileBrowser-Container"></div>

	<script>
	// ------------------------------------------------------------------
	// Inline FileBrowser application with layout support
	//
	// The tree uses lazy loading via the /children endpoint.
	// Layout switcher in the header controls which panes are visible
	// and how they are arranged.
	// ------------------------------------------------------------------

	var API_PREFIX = '/api/filebrowser';

	// ---- Layout definitions (mirrors the provider) ----
	var Layouts =
	{
		'list-only':
		{
			Key: 'list-only',
			Label: 'List Only',
			Description: 'Full-width file list',
			Panes: ['list'],
			PaneCount: 1
		},
		'tree-list':
		{
			Key: 'tree-list',
			Label: 'Tree + List',
			Description: 'Folder tree on the left, file list on the right',
			Panes: ['browse', 'list'],
			PaneCount: 2
		},
		'list-detail':
		{
			Key: 'list-detail',
			Label: 'List + Detail',
			Description: 'File list on top, file details on the bottom',
			Panes: ['list', 'view'],
			PaneCount: 2
		},
		'tree-detail':
		{
			Key: 'tree-detail',
			Label: 'Tree + Detail',
			Description: 'Folder tree on the left, file details on the right',
			Panes: ['browse', 'view'],
			PaneCount: 2
		},
		'browser-detail':
		{
			Key: 'browser-detail',
			Label: 'Browser',
			Description: 'Tree left, list top-right, details bottom-right',
			Panes: ['browse', 'list', 'view'],
			PaneCount: 3
		},
		'browser-columns':
		{
			Key: 'browser-columns',
			Label: 'Columns',
			Description: 'Three-column: tree, list, and details side-by-side',
			Panes: ['browse', 'list', 'view'],
			PaneCount: 3
		}
	};

	// Sorted layout order for the switcher (by pane count, then key)
	var LayoutOrder = ['list-only', 'list-detail', 'tree-list', 'tree-detail', 'browser-detail', 'browser-columns'];

	// ---- State ----
	var AppState =
	{
		currentLayout: 'browser-detail',
		currentLocation: '',
		currentFile: null,
		fileList: [],
		sortField: 'Name',
		sortAscending: true,
		searchTimer: null,
		treeNodes: {}
	};

	// ---- Layout helpers ----
	function getCurrentLayout()
	{
		return Layouts[AppState.currentLayout] || Layouts['browser-detail'];
	}

	function hasPaneRole(pRole)
	{
		return getCurrentLayout().Panes.indexOf(pRole) >= 0;
	}

	function switchLayout(pKey)
	{
		if (!Layouts[pKey] || pKey === AppState.currentLayout) return;
		AppState.currentLayout = pKey;
		renderLayout();

		// Re-populate pane content
		if (hasPaneRole('browse'))
		{
			renderTree();
			// Load root children if not already loaded
			var tmpRoot = getTreeNode('');
			if (!tmpRoot.loaded)
			{
				tmpRoot.expanded = true;
				loadChildren('');
			}
		}
		if (hasPaneRole('list'))
		{
			renderFileList();
		}
		if (hasPaneRole('view'))
		{
			renderFileInfo();
		}

		renderLayoutSwitcher();
	}

	// ---- API helpers ----
	function apiGet(pEndpoint, pParams, fCallback)
	{
		var tmpQuery = '';
		if (pParams)
		{
			var tmpParts = [];
			for (var tmpKey in pParams)
			{
				tmpParts.push(encodeURIComponent(tmpKey) + '=' + encodeURIComponent(pParams[tmpKey]));
			}
			if (tmpParts.length > 0)
			{
				tmpQuery = '?' + tmpParts.join('&');
			}
		}

		var tmpXHR = new XMLHttpRequest();
		tmpXHR.open('GET', API_PREFIX + pEndpoint + tmpQuery, true);
		tmpXHR.onload = function()
		{
			if (tmpXHR.status >= 200 && tmpXHR.status < 300)
			{
				try { fCallback(null, JSON.parse(tmpXHR.responseText)); }
				catch (pError) { fCallback(pError); }
			}
			else { fCallback(new Error('HTTP ' + tmpXHR.status)); }
		};
		tmpXHR.onerror = function() { fCallback(new Error('Network error')); };
		tmpXHR.send();
	}

	// ---- SVG Icon Set (Retro / Hand-Drawn style) ----
	var C_PRIMARY = '#3D3229';
	var C_ACCENT = '#2E7D74';
	var C_MUTED = '#8A7F72';
	var C_LIGHT = '#F5F0E8';

	var SVGIcons =
	{
		'folder': function(pS)
		{
			return '<svg width="' + pS + '" height="' + pS + '" viewBox="0 0 24 24" fill="none"><path d="M3.2 7.1V17.2C3.2 18.2 4 19.1 5.1 18.9L19.1 19.1C20 19.1 20.9 18.2 20.8 17.1V9.1C20.9 8 20.1 7.1 19 7.1H12.1L10.1 4.9H5.1C3.9 5 3.1 5.9 3.2 7.1Z" fill="#EAE3D8" stroke="' + C_PRIMARY + '" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" /><path d="M3.2 9H20.8" stroke="' + C_PRIMARY + '" stroke-width="1" opacity="0.3" /></svg>';
		},
		'file': function(pS)
		{
			return '<svg width="' + pS + '" height="' + pS + '" viewBox="0 0 24 24" fill="none"><path d="M14.1 2.1H6.2C5 2.2 4.1 3 4.1 4.1V20.1C4 21.2 5 22 6.1 21.9H18C19.1 22 20 21.1 19.9 19.9V8.1L14.1 2.1Z" fill="' + C_LIGHT + '" stroke="' + C_PRIMARY + '" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" /><path d="M13.9 2.1V8.2H20" stroke="' + C_PRIMARY + '" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" /></svg>';
		},
		'file-text': function(pS)
		{
			return '<svg width="' + pS + '" height="' + pS + '" viewBox="0 0 24 24" fill="none"><path d="M14.1 2.1H6.2C5 2.2 4.1 3 4.1 4.1V20.1C4 21.2 5 22 6.1 21.9H18C19.1 22 20 21.1 19.9 19.9V8.1L14.1 2.1Z" fill="' + C_LIGHT + '" stroke="' + C_PRIMARY + '" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" /><path d="M13.9 2.1V8.2H20" stroke="' + C_PRIMARY + '" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" /><line x1="8.1" y1="12.8" x2="15.9" y2="12.8" stroke="' + C_MUTED + '" stroke-width="1.2" stroke-linecap="round" /><line x1="8.1" y1="15.8" x2="15.9" y2="15.8" stroke="' + C_MUTED + '" stroke-width="1.2" stroke-linecap="round" /><line x1="8.1" y1="18.8" x2="12.2" y2="18.8" stroke="' + C_MUTED + '" stroke-width="1.2" stroke-linecap="round" /></svg>';
		},
		'file-code': function(pS)
		{
			return '<svg width="' + pS + '" height="' + pS + '" viewBox="0 0 24 24" fill="none"><path d="M14.1 2.1H6.2C5 2.2 4.1 3 4.1 4.1V20.1C4 21.2 5 22 6.1 21.9H18C19.1 22 20 21.1 19.9 19.9V8.1L14.1 2.1Z" fill="' + C_LIGHT + '" stroke="' + C_PRIMARY + '" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" /><path d="M13.9 2.1V8.2H20" stroke="' + C_PRIMARY + '" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" /><path d="M8.5 13.2L6.8 15.1L8.6 16.8" stroke="' + C_ACCENT + '" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round" /><path d="M15.5 13.2L17.2 15.1L15.4 16.8" stroke="' + C_ACCENT + '" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round" /><line x1="12.8" y1="12" x2="11.2" y2="18" stroke="' + C_MUTED + '" stroke-width="1.2" stroke-linecap="round" /></svg>';
		},
		'file-image': function(pS)
		{
			return '<svg width="' + pS + '" height="' + pS + '" viewBox="0 0 24 24" fill="none"><rect x="3.1" y="3.2" width="17.8" height="17.7" rx="2" fill="#E8E0F0" stroke="' + C_PRIMARY + '" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" /><circle cx="8.3" cy="8.7" r="1.8" fill="' + C_ACCENT + '" /><path d="M20.8 15.2L15.9 10.1L5.2 20.8" stroke="' + C_PRIMARY + '" stroke-width="1.8" fill="none" stroke-linecap="round" stroke-linejoin="round" /></svg>';
		},
		'file-pdf': function(pS)
		{
			return '<svg width="' + pS + '" height="' + pS + '" viewBox="0 0 24 24" fill="none"><path d="M14.1 2.1H6.2C5 2.2 4.1 3 4.1 4.1V20.1C4 21.2 5 22 6.1 21.9H18C19.1 22 20 21.1 19.9 19.9V8.1L14.1 2.1Z" fill="#F0DDDD" stroke="' + C_PRIMARY + '" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" /><path d="M13.9 2.1V8.2H20" stroke="' + C_PRIMARY + '" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" /><text x="8.2" y="16.8" font-family="sans-serif" font-weight="700" font-size="6.5" fill="#C04040" letter-spacing="-0.3">PDF</text></svg>';
		},
		'file-spreadsheet': function(pS)
		{
			return '<svg width="' + pS + '" height="' + pS + '" viewBox="0 0 24 24" fill="none"><path d="M14.1 2.1H6.2C5 2.2 4.1 3 4.1 4.1V20.1C4 21.2 5 22 6.1 21.9H18C19.1 22 20 21.1 19.9 19.9V8.1L14.1 2.1Z" fill="#E0EDE9" stroke="' + C_PRIMARY + '" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" /><path d="M13.9 2.1V8.2H20" stroke="' + C_PRIMARY + '" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" /><rect x="7.2" y="11.1" width="9.8" height="7.8" rx="0.5" fill="none" stroke="' + C_ACCENT + '" stroke-width="1.2" /><line x1="7.2" y1="13.7" x2="17" y2="13.7" stroke="' + C_ACCENT + '" stroke-width="1" /><line x1="7.2" y1="16.3" x2="17" y2="16.3" stroke="' + C_ACCENT + '" stroke-width="1" /><line x1="10.9" y1="11.1" x2="10.9" y2="18.9" stroke="' + C_ACCENT + '" stroke-width="1" /></svg>';
		},
		'file-archive': function(pS)
		{
			return '<svg width="' + pS + '" height="' + pS + '" viewBox="0 0 24 24" fill="none"><path d="M14.1 2.1H6.2C5 2.2 4.1 3 4.1 4.1V20.1C4 21.2 5 22 6.1 21.9H18C19.1 22 20 21.1 19.9 19.9V8.1L14.1 2.1Z" fill="#EAE3D8" stroke="' + C_PRIMARY + '" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" /><path d="M13.9 2.1V8.2H20" stroke="' + C_PRIMARY + '" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" /><rect x="8.8" y="11.2" width="2.5" height="2" rx="0.4" fill="' + C_PRIMARY + '" /><rect x="8.8" y="14.2" width="2.5" height="2" rx="0.4" fill="' + C_PRIMARY + '" /><rect x="8.8" y="17.2" width="2.5" height="2" rx="0.4" fill="' + C_PRIMARY + '" /></svg>';
		},
		'file-audio': function(pS)
		{
			return '<svg width="' + pS + '" height="' + pS + '" viewBox="0 0 24 24" fill="none"><path d="M14.1 2.1H6.2C5 2.2 4.1 3 4.1 4.1V20.1C4 21.2 5 22 6.1 21.9H18C19.1 22 20 21.1 19.9 19.9V8.1L14.1 2.1Z" fill="#F0E8D0" stroke="' + C_PRIMARY + '" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" /><path d="M13.9 2.1V8.2H20" stroke="' + C_PRIMARY + '" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" /><circle cx="10.2" cy="16.8" r="2.1" fill="none" stroke="' + C_ACCENT + '" stroke-width="1.5" /><path d="M12.2 16.8V11.2L16.1 10.1" stroke="' + C_ACCENT + '" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" fill="none" /><circle cx="16.1" cy="15.3" r="1.4" fill="none" stroke="' + C_ACCENT + '" stroke-width="1.2" /></svg>';
		},
		'file-video': function(pS)
		{
			return '<svg width="' + pS + '" height="' + pS + '" viewBox="0 0 24 24" fill="none"><path d="M14.1 2.1H6.2C5 2.2 4.1 3 4.1 4.1V20.1C4 21.2 5 22 6.1 21.9H18C19.1 22 20 21.1 19.9 19.9V8.1L14.1 2.1Z" fill="#E8E0F0" stroke="' + C_PRIMARY + '" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" /><path d="M13.9 2.1V8.2H20" stroke="' + C_PRIMARY + '" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" /><path d="M9.8 12.2V18.2L15.8 15.2L9.8 12.2Z" fill="' + C_ACCENT + '" stroke="' + C_ACCENT + '" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round" /></svg>';
		},
		'file-web': function(pS)
		{
			return '<svg width="' + pS + '" height="' + pS + '" viewBox="0 0 24 24" fill="none"><circle cx="12" cy="12" r="8.9" fill="#E0EDE9" stroke="' + C_PRIMARY + '" stroke-width="1.8" /><ellipse cx="12" cy="12" rx="4.1" ry="8.9" fill="none" stroke="' + C_PRIMARY + '" stroke-width="1.2" /><line x1="3.1" y1="12" x2="20.9" y2="12" stroke="' + C_PRIMARY + '" stroke-width="1" /><path d="M4.8 7.8C7 8.5 9.4 8.9 12 8.9C14.6 8.9 17 8.5 19.2 7.8" stroke="' + C_PRIMARY + '" stroke-width="1" fill="none" /><path d="M4.8 16.2C7 15.5 9.4 15.1 12 15.1C14.6 15.1 17 15.5 19.2 16.2" stroke="' + C_PRIMARY + '" stroke-width="1" fill="none" /></svg>';
		},
		'file-config': function(pS)
		{
			return '<svg width="' + pS + '" height="' + pS + '" viewBox="0 0 24 24" fill="none"><path d="M14.1 2.1H6.2C5 2.2 4.1 3 4.1 4.1V20.1C4 21.2 5 22 6.1 21.9H18C19.1 22 20 21.1 19.9 19.9V8.1L14.1 2.1Z" fill="' + C_LIGHT + '" stroke="' + C_PRIMARY + '" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" /><path d="M13.9 2.1V8.2H20" stroke="' + C_PRIMARY + '" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" /><circle cx="12" cy="15" r="2.8" fill="none" stroke="' + C_MUTED + '" stroke-width="1.5" /><line x1="12" y1="11" x2="12" y2="12.2" stroke="' + C_MUTED + '" stroke-width="1.3" stroke-linecap="round" /><line x1="12" y1="17.8" x2="12" y2="19" stroke="' + C_MUTED + '" stroke-width="1.3" stroke-linecap="round" /></svg>';
		},
		'home': function(pS)
		{
			return '<svg width="' + pS + '" height="' + pS + '" viewBox="0 0 24 24" fill="none"><path d="M3.1 9.6L12 3.1L20.9 9.6V19.9C20.9 20.5 20.5 21 19.9 20.9H4.1C3.5 21 3 20.5 3.1 19.9V9.6Z" fill="#E0EDE9" stroke="' + C_ACCENT + '" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" /><rect x="9.2" y="14.1" width="5.6" height="6.9" rx="0.5" fill="' + C_ACCENT + '" /></svg>';
		},
		'arrow-up': function(pS)
		{
			return '<svg width="' + pS + '" height="' + pS + '" viewBox="0 0 24 24" fill="none"><path d="M12.1 19.1V5.1" stroke="' + C_MUTED + '" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" /><path d="M5.2 11.9L12.1 5.1L18.9 11.9" stroke="' + C_MUTED + '" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round" /></svg>';
		},
		'chevron-right': function(pS)
		{
			return '<svg width="' + pS + '" height="' + pS + '" viewBox="0 0 24 24" fill="none"><path d="M9.2 6.1L14.8 12.1L9.1 17.9" stroke="' + C_MUTED + '" stroke-width="2.5" fill="none" stroke-linecap="round" stroke-linejoin="round" /></svg>';
		},
		'chevron-down': function(pS)
		{
			return '<svg width="' + pS + '" height="' + pS + '" viewBox="0 0 24 24" fill="none"><path d="M6.1 9.2L12.1 14.8L17.9 9.1" stroke="' + C_MUTED + '" stroke-width="2.5" fill="none" stroke-linecap="round" stroke-linejoin="round" /></svg>';
		}
	};

	var ExtMap =
	{
		'.jpg': 'file-image', '.jpeg': 'file-image', '.png': 'file-image', '.gif': 'file-image', '.svg': 'file-image', '.webp': 'file-image', '.bmp': 'file-image',
		'.txt': 'file-text', '.md': 'file-text', '.rtf': 'file-text', '.doc': 'file-text', '.docx': 'file-text',
		'.pdf': 'file-pdf',
		'.xls': 'file-spreadsheet', '.xlsx': 'file-spreadsheet', '.csv': 'file-spreadsheet',
		'.js': 'file-code', '.ts': 'file-code', '.jsx': 'file-code', '.tsx': 'file-code', '.py': 'file-code', '.rb': 'file-code',
		'.java': 'file-code', '.c': 'file-code', '.cpp': 'file-code', '.go': 'file-code', '.rs': 'file-code',
		'.sh': 'file-code', '.php': 'file-code',
		'.html': 'file-web', '.htm': 'file-web', '.css': 'file-web', '.scss': 'file-web', '.xml': 'file-web',
		'.json': 'file-config', '.yaml': 'file-config', '.yml': 'file-config', '.toml': 'file-config', '.ini': 'file-config', '.env': 'file-config',
		'.zip': 'file-archive', '.tar': 'file-archive', '.gz': 'file-archive', '.rar': 'file-archive', '.7z': 'file-archive', '.tgz': 'file-archive',
		'.mp3': 'file-audio', '.wav': 'file-audio', '.flac': 'file-audio', '.ogg': 'file-audio', '.aac': 'file-audio',
		'.mp4': 'file-video', '.avi': 'file-video', '.mov': 'file-video', '.mkv': 'file-video', '.webm': 'file-video'
	};

	// ---- Icon / format helpers ----
	function getEntryIcon(pEntry)
	{
		if (!pEntry) return '';
		if (pEntry.Icon && pEntry.Icon.indexOf('<svg') === 0) return pEntry.Icon;
		if (pEntry.Type === 'folder') return SVGIcons['folder'](16);
		var tmpExt = (pEntry.Extension || '').toLowerCase();
		var tmpIconName = ExtMap[tmpExt];
		if (tmpIconName && SVGIcons[tmpIconName]) return SVGIcons[tmpIconName](16);
		return SVGIcons['file'](16);
	}

	function formatFileSize(pSize)
	{
		if (pSize == null || isNaN(pSize)) return '--';
		if (pSize < 1024) return pSize + ' B';
		if (pSize < 1048576) return (pSize / 1024).toFixed(1) + ' KB';
		if (pSize < 1073741824) return (pSize / 1048576).toFixed(1) + ' MB';
		return (pSize / 1073741824).toFixed(1) + ' GB';
	}

	function formatDate(pDate)
	{
		if (!pDate) return '--';
		try
		{
			var tmpDate = new Date(pDate);
			if (isNaN(tmpDate.getTime())) return '--';
			return tmpDate.toLocaleDateString() + ' ' + tmpDate.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
		}
		catch (e) { return '--'; }
	}

	function getFileTypeDescription(pEntry)
	{
		if (!pEntry) return 'Unknown';
		if (pEntry.Type === 'folder') return 'Folder';
		var tmpExt = (pEntry.Extension || '').toLowerCase();
		var tmpTypes =
		{
			'.jpg': 'JPEG Image', '.jpeg': 'JPEG Image', '.png': 'PNG Image', '.gif': 'GIF Image', '.svg': 'SVG Image', '.webp': 'WebP Image',
			'.pdf': 'PDF Document', '.doc': 'Word Document', '.docx': 'Word Document', '.txt': 'Text File', '.md': 'Markdown File',
			'.html': 'HTML File', '.css': 'CSS Stylesheet', '.js': 'JavaScript File', '.ts': 'TypeScript File',
			'.json': 'JSON File', '.xml': 'XML File', '.yaml': 'YAML File', '.yml': 'YAML File',
			'.py': 'Python Script', '.rb': 'Ruby Script', '.java': 'Java File', '.go': 'Go Source File',
			'.zip': 'ZIP Archive', '.tar': 'TAR Archive', '.gz': 'GZip Archive',
			'.mp3': 'MP3 Audio', '.wav': 'WAV Audio', '.mp4': 'MP4 Video', '.avi': 'AVI Video', '.mov': 'QuickTime Video',
			'.csv': 'CSV File', '.xls': 'Excel Spreadsheet', '.xlsx': 'Excel Spreadsheet'
		};
		return tmpTypes[tmpExt] || (tmpExt ? tmpExt.substring(1).toUpperCase() + ' File' : 'File');
	}

	function escapeHTML(pText)
	{
		if (!pText) return '';
		return String(pText).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
	}

	// ---- Layout rendering ----
	function renderLayoutSwitcher()
	{
		var tmpSwitcher = document.getElementById('App-Layout-Switcher');
		if (!tmpSwitcher) return;

		var tmpHTML = '';
		for (var i = 0; i < LayoutOrder.length; i++)
		{
			var tmpKey = LayoutOrder[i];
			var tmpLayout = Layouts[tmpKey];
			var tmpActive = (tmpKey === AppState.currentLayout) ? ' active' : '';
			tmpHTML += '<button class="pict-fb-layout-btn' + tmpActive + '" onclick="switchLayout(\'' + tmpKey + '\')" title="' + escapeHTML(tmpLayout.Description) + '">' + escapeHTML(tmpLayout.Label) + '</button>';
		}
		tmpSwitcher.innerHTML = tmpHTML;
	}

	function renderLayout()
	{
		var tmpContainer = document.getElementById('Pict-FileBrowser-Container');
		var tmpLayoutKey = AppState.currentLayout;
		var tmpHTML = '';

		switch (tmpLayoutKey)
		{
			case 'list-only':
				// 1 pane: full-width list
				tmpHTML =
					'<div class="pict-filebrowser pict-fb-layout-list-only">' +
						'<div class="pict-filebrowser-list-pane pict-fb-pane-full" id="FB-ListPane"></div>' +
					'</div>';
				break;

			case 'tree-list':
				// 2 panes: tree left, list right
				tmpHTML =
					'<div class="pict-filebrowser pict-fb-layout-tree-list">' +
						'<div class="pict-filebrowser-browse-pane" id="FB-BrowsePane"></div>' +
						'<div class="pict-filebrowser-list-pane pict-fb-pane-full" id="FB-ListPane"></div>' +
					'</div>';
				break;

			case 'list-detail':
				// 2 panes: list top, detail bottom
				tmpHTML =
					'<div class="pict-filebrowser pict-fb-layout-list-detail">' +
						'<div class="pict-filebrowser-list-pane" id="FB-ListPane"></div>' +
						'<div class="pict-filebrowser-view-pane" id="FB-ViewPane"></div>' +
					'</div>';
				break;

			case 'tree-detail':
				// 2 panes: tree left, detail right
				tmpHTML =
					'<div class="pict-filebrowser pict-fb-layout-tree-detail">' +
						'<div class="pict-filebrowser-browse-pane" id="FB-BrowsePane"></div>' +
						'<div class="pict-filebrowser-view-pane pict-fb-pane-full" id="FB-ViewPane"></div>' +
					'</div>';
				break;

			case 'browser-columns':
				// 3 panes: tree, list, detail as columns
				tmpHTML =
					'<div class="pict-filebrowser pict-fb-layout-browser-columns">' +
						'<div class="pict-filebrowser-browse-pane" id="FB-BrowsePane"></div>' +
						'<div class="pict-filebrowser-list-pane" id="FB-ListPane"></div>' +
						'<div class="pict-filebrowser-view-pane pict-fb-column-view" id="FB-ViewPane"></div>' +
					'</div>';
				break;

			case 'browser-detail':
			default:
				// 3 panes: tree left, list top-right, detail bottom-right
				tmpHTML =
					'<div class="pict-filebrowser pict-fb-layout-browser-detail">' +
						'<div class="pict-filebrowser-browse-pane" id="FB-BrowsePane"></div>' +
						'<div class="pict-filebrowser-main-pane">' +
							'<div class="pict-filebrowser-list-pane" id="FB-ListPane"></div>' +
							'<div class="pict-filebrowser-view-pane" id="FB-ViewPane"></div>' +
						'</div>' +
					'</div>';
				break;
		}

		tmpContainer.innerHTML = tmpHTML;
		injectCSS();
	}

	// ---- CSS injection ----
	var _cssInjected = false;
	function injectCSS()
	{
		if (_cssInjected) return;
		_cssInjected = true;

		var tmpStyle = document.createElement('style');
		tmpStyle.textContent = '\
/* === Base pane styles === */\
.pict-filebrowser { display: flex; height: 100%; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; font-size: 14px; color: #3D3229; border: 1px solid #DDD6CA; border-radius: 4px; overflow: hidden; background: #FAFAF8; }\
.pict-filebrowser-browse-pane { width: 240px; min-width: 180px; border-right: 1px solid #DDD6CA; overflow-y: auto; background: #F5F0E8; flex-shrink: 0; }\
.pict-filebrowser-main-pane { display: flex; flex-direction: column; flex: 1; min-width: 0; }\
.pict-filebrowser-list-pane { flex: 1; overflow-y: auto; overflow-x: hidden; }\
.pict-filebrowser-view-pane { border-top: 1px solid #DDD6CA; overflow-y: auto; background: #FAFAF8; }\
.pict-fb-pane-full { flex: 1; min-width: 0; }\
\
/* === Layout: list-only (1 pane) === */\
.pict-fb-layout-list-only { flex-direction: column; }\
.pict-fb-layout-list-only .pict-filebrowser-list-pane { border-top: none; }\
\
/* === Layout: tree-list (2 panes, side by side) === */\
.pict-fb-layout-tree-list { flex-direction: row; }\
.pict-fb-layout-tree-list .pict-filebrowser-list-pane { border-top: none; }\
\
/* === Layout: list-detail (2 panes, stacked) === */\
.pict-fb-layout-list-detail { flex-direction: column; }\
.pict-fb-layout-list-detail .pict-filebrowser-list-pane { flex: 1; border-top: none; }\
.pict-fb-layout-list-detail .pict-filebrowser-view-pane { flex: 0 0 auto; max-height: 40%; border-top: 1px solid #DDD6CA; }\
\
/* === Layout: tree-detail (2 panes, side by side) === */\
.pict-fb-layout-tree-detail { flex-direction: row; }\
.pict-fb-layout-tree-detail .pict-filebrowser-view-pane { border-top: none; border-left: none; }\
\
/* === Layout: browser-detail (3 panes, tree | list/detail stacked) === */\
.pict-fb-layout-browser-detail { flex-direction: row; }\
.pict-fb-layout-browser-detail .pict-filebrowser-main-pane { display: flex; flex-direction: column; flex: 1; min-width: 0; }\
.pict-fb-layout-browser-detail .pict-filebrowser-list-pane { flex: 1; }\
.pict-fb-layout-browser-detail .pict-filebrowser-view-pane { flex: 0 0 auto; max-height: 40%; border-top: 1px solid #DDD6CA; }\
\
/* === Layout: browser-columns (3 panes, all columns) === */\
.pict-fb-layout-browser-columns { flex-direction: row; }\
.pict-fb-layout-browser-columns .pict-filebrowser-list-pane { flex: 1; min-width: 0; border-right: 1px solid #DDD6CA; border-top: none; }\
.pict-fb-layout-browser-columns .pict-fb-column-view { flex: 1; min-width: 0; border-top: none; border-left: none; overflow-y: auto; }\
\
/* === Tree === */\
.pict-fb-tree { padding: 8px 0; } .pict-fb-tree-node { display: flex; align-items: center; padding: 4px 8px 4px 0; cursor: pointer; user-select: none; white-space: nowrap; } .pict-fb-tree-node:hover { background: #EAE3D8; } .pict-fb-tree-node.selected { background: #DDD6CA; font-weight: 600; } .pict-fb-tree-toggle { display: inline-block; width: 16px; text-align: center; flex-shrink: 0; color: #8A7F72; font-size: 10px; cursor: pointer; } .pict-fb-tree-toggle-empty { display: inline-block; width: 16px; flex-shrink: 0; } .pict-fb-tree-icon { margin-right: 6px; flex-shrink: 0; } .pict-fb-tree-label { overflow: hidden; text-overflow: ellipsis; } .pict-fb-tree-children { display: none; } .pict-fb-tree-children.expanded { display: block; } .pict-fb-tree-loading { padding: 4px 8px; color: #8A7F72; font-size: 12px; font-style: italic; }\
\
/* === Search === */\
.pict-fb-search { padding: 8px; } .pict-fb-search-input { width: 100%; box-sizing: border-box; padding: 6px 10px; border: 1px solid #DDD6CA; border-radius: 4px; font-size: 13px; outline: none; background: #fff; } .pict-fb-search-input:focus { border-color: #2E7D74; } .pict-fb-search-results { margin-top: 4px; } .pict-fb-search-result { display: flex; align-items: center; padding: 5px 8px; cursor: pointer; border-radius: 3px; } .pict-fb-search-result:hover { background: #EAE3D8; } .pict-fb-search-result-icon { margin-right: 6px; flex-shrink: 0; } .pict-fb-search-result-name { overflow: hidden; text-overflow: ellipsis; white-space: nowrap; } .pict-fb-search-result-path { color: #8A7F72; font-size: 11px; margin-left: auto; padding-left: 8px; white-space: nowrap; }\
\
/* === Detail list === */\
.pict-fb-detail { width: 100%; } .pict-fb-detail-header { display: flex; padding: 6px 12px; font-weight: 600; font-size: 12px; text-transform: uppercase; color: #8A7F72; border-bottom: 1px solid #DDD6CA; background: #F5F0E8; user-select: none; } .pict-fb-detail-header-cell { overflow: hidden; text-overflow: ellipsis; white-space: nowrap; cursor: pointer; } .pict-fb-detail-header-cell:hover { color: #3D3229; } .pict-fb-detail-col-name { flex: 1; min-width: 0; } .pict-fb-detail-col-size { width: 90px; text-align: right; flex-shrink: 0; padding-right: 12px; } .pict-fb-detail-col-modified { width: 150px; flex-shrink: 0; } .pict-fb-detail-row { display: flex; align-items: center; padding: 5px 12px; cursor: pointer; border-bottom: 1px solid #F0ECE4; } .pict-fb-detail-row:hover { background: #F0ECE4; } .pict-fb-detail-row.selected { background: #E0EDE9; } .pict-fb-detail-icon { margin-right: 8px; flex-shrink: 0; font-size: 16px; } .pict-fb-detail-name { flex: 1; min-width: 0; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; } .pict-fb-detail-size { width: 90px; text-align: right; flex-shrink: 0; padding-right: 12px; color: #8A7F72; font-size: 12px; } .pict-fb-detail-modified { width: 150px; flex-shrink: 0; color: #8A7F72; font-size: 12px; }\
\
/* === Parent row === */\
.pict-fb-parent-row { color: #8A7F72; } .pict-fb-parent-row .pict-fb-detail-name { font-weight: 500; }\
\
/* === Breadcrumb === */\
.pict-fb-breadcrumb { display: flex; align-items: center; padding: 6px 12px; font-size: 13px; background: #F5F0E8; border-bottom: 1px solid #DDD6CA; overflow-x: auto; white-space: nowrap; } .pict-fb-breadcrumb-segment { cursor: pointer; color: #2E7D74; padding: 2px 6px; border-radius: 3px; text-decoration: none; } .pict-fb-breadcrumb-segment:hover { background: #DDD6CA; text-decoration: underline; } .pict-fb-breadcrumb-separator { margin: 0 2px; color: #8A7F72; } .pict-fb-breadcrumb-current { color: #3D3229; font-weight: 500; padding: 2px 6px; }\
\
/* === File info === */\
.pict-fb-fileinfo { padding: 12px 16px; } .pict-fb-fileinfo-title { font-size: 15px; font-weight: 600; margin-bottom: 8px; color: #3D3229; } .pict-fb-fileinfo-table { width: 100%; font-size: 13px; } .pict-fb-fileinfo-table td { padding: 3px 0; } .pict-fb-fileinfo-label { color: #8A7F72; width: 100px; font-weight: 500; } .pict-fb-fileinfo-value { color: #423D37; } .pict-fb-fileinfo-none { color: #8A7F72; font-style: italic; padding: 12px 16px; }\
\
/* === Empty state === */\
.pict-fb-empty { display: flex; align-items: center; justify-content: center; padding: 32px; color: #8A7F72; font-style: italic; }\
\
/* === SVG icon alignment === */\
.pict-fb-tree-icon svg, .pict-fb-detail-icon svg, .pict-fb-search-result-icon svg, .pict-fb-breadcrumb-segment svg { display: inline-block; vertical-align: middle; }\
.pict-fb-tree-toggle svg { display: inline-block; vertical-align: middle; }\
#App-Header-Icon svg { display: inline-block; vertical-align: middle; }\
		';
		document.head.appendChild(tmpStyle);
	}

	// ---- Tree state helpers ----
	function getTreeNode(pPath)
	{
		if (!AppState.treeNodes[pPath])
		{
			AppState.treeNodes[pPath] =
			{
				children: [],
				loaded: false,
				expanded: false,
				hasChildren: true
			};
		}
		return AppState.treeNodes[pPath];
	}

	// ---- Tree rendering ----
	function renderTree()
	{
		var tmpPane = document.getElementById('FB-BrowsePane');
		if (!tmpPane) return;

		var tmpSearchHTML = '<div class="pict-fb-search">' +
			'<input type="text" class="pict-fb-search-input" id="FB-SearchInput" placeholder="Search files..." oninput="onSearchInput(this.value)" />' +
			'<div class="pict-fb-search-results" id="FB-SearchResults"></div>' +
			'</div>';

		var tmpRootNode = getTreeNode('');
		var tmpTreeHTML = '<div class="pict-fb-tree" id="FB-Tree">';

		var tmpRootSelected = (AppState.currentLocation === '') ? ' selected' : '';
		tmpTreeHTML += '<div class="pict-fb-tree-node' + tmpRootSelected + '" style="padding-left: 8px;" onclick="selectFolder(\'\')">';
		tmpTreeHTML += '<span class="pict-fb-tree-toggle" onclick="event.stopPropagation(); toggleTreeNode(\'\')">' + (tmpRootNode.expanded ? SVGIcons['chevron-down'](10) : SVGIcons['chevron-right'](10)) + '</span>';
		tmpTreeHTML += '<span class="pict-fb-tree-icon">' + SVGIcons['home'](16) + '</span>';
		tmpTreeHTML += '<span class="pict-fb-tree-label">Root</span>';
		tmpTreeHTML += '</div>';

		tmpTreeHTML += '<div class="pict-fb-tree-children' + (tmpRootNode.expanded ? ' expanded' : '') + '">';
		if (tmpRootNode.loaded)
		{
			tmpTreeHTML += renderTreeLevel(tmpRootNode.children, 1);
		}
		else if (tmpRootNode.expanded)
		{
			tmpTreeHTML += '<div class="pict-fb-tree-loading" style="padding-left: 24px;">Loading...</div>';
		}
		tmpTreeHTML += '</div>';
		tmpTreeHTML += '</div>';

		tmpPane.innerHTML = tmpSearchHTML + tmpTreeHTML;
	}

	function renderTreeLevel(pChildren, pDepth)
	{
		if (!Array.isArray(pChildren) || pChildren.length === 0) return '';
		var tmpHTML = '';
		for (var i = 0; i < pChildren.length; i++)
		{
			var tmpChild = pChildren[i];
			var tmpPath = tmpChild.Path;
			var tmpNode = getTreeNode(tmpPath);
			var tmpIsSelected = (tmpPath === AppState.currentLocation);

			tmpHTML += '<div class="pict-fb-tree-node' + (tmpIsSelected ? ' selected' : '') + '" ' +
				'style="padding-left: ' + (8 + pDepth * 16) + 'px;" ' +
				'onclick="selectFolder(\'' + escapeHTML(tmpPath) + '\')">';

			if (tmpChild.HasChildren || (tmpNode.loaded && tmpNode.children.length > 0))
			{
				tmpHTML += '<span class="pict-fb-tree-toggle" onclick="event.stopPropagation(); toggleTreeNode(\'' + escapeHTML(tmpPath) + '\')">' + (tmpNode.expanded ? SVGIcons['chevron-down'](10) : SVGIcons['chevron-right'](10)) + '</span>';
			}
			else
			{
				tmpHTML += '<span class="pict-fb-tree-toggle-empty"></span>';
			}

			tmpHTML += '<span class="pict-fb-tree-icon">' + SVGIcons['folder'](16) + '</span>';
			tmpHTML += '<span class="pict-fb-tree-label">' + escapeHTML(tmpChild.Name) + '</span>';
			tmpHTML += '</div>';

			if (tmpNode.expanded)
			{
				tmpHTML += '<div class="pict-fb-tree-children expanded">';
				if (tmpNode.loaded)
				{
					tmpHTML += renderTreeLevel(tmpNode.children, pDepth + 1);
				}
				else
				{
					tmpHTML += '<div class="pict-fb-tree-loading" style="padding-left: ' + (24 + pDepth * 16) + 'px;">Loading...</div>';
				}
				tmpHTML += '</div>';
			}
		}
		return tmpHTML;
	}

	// ---- Breadcrumb rendering ----
	function renderBreadcrumbHTML()
	{
		var tmpHTML = '<div class="pict-fb-breadcrumb">';
		tmpHTML += '<span class="pict-fb-breadcrumb-segment" onclick="navigateToPath(\'\')">' + SVGIcons['home'](14) + ' Root</span>';
		if (AppState.currentLocation)
		{
			var tmpParts = AppState.currentLocation.split('/');
			var tmpAccum = '';
			for (var i = 0; i < tmpParts.length; i++)
			{
				tmpAccum = tmpAccum ? (tmpAccum + '/' + tmpParts[i]) : tmpParts[i];
				tmpHTML += '<span class="pict-fb-breadcrumb-separator">/</span>';
				if (i === tmpParts.length - 1)
				{
					tmpHTML += '<span class="pict-fb-breadcrumb-current">' + escapeHTML(tmpParts[i]) + '</span>';
				}
				else
				{
					tmpHTML += '<span class="pict-fb-breadcrumb-segment" onclick="navigateToPath(\'' + escapeHTML(tmpAccum) + '\')">' + escapeHTML(tmpParts[i]) + '</span>';
				}
			}
		}
		tmpHTML += '</div>';
		return tmpHTML;
	}

	// ---- File list rendering ----
	function renderFileList()
	{
		var tmpPane = document.getElementById('FB-ListPane');
		if (!tmpPane) return;

		var tmpHTML = '<div class="pict-fb-detail">';

		// Breadcrumb
		tmpHTML += renderBreadcrumbHTML();

		// Column header
		tmpHTML += '<div class="pict-fb-detail-header">' +
			'<div class="pict-fb-detail-header-cell pict-fb-detail-col-name" onclick="sortBy(\'Name\')">Name</div>' +
			'<div class="pict-fb-detail-header-cell pict-fb-detail-col-size" onclick="sortBy(\'Size\')">Size</div>' +
			'<div class="pict-fb-detail-header-cell pict-fb-detail-col-modified" onclick="sortBy(\'Modified\')">Modified</div>' +
			'</div>';

		var tmpList = getSortedFileList();

		// Show a ".." parent row when inside a subfolder
		if (AppState.currentLocation)
		{
			var tmpParentPath = '';
			var tmpLocParts = AppState.currentLocation.split('/');
			if (tmpLocParts.length > 1)
			{
				tmpParentPath = tmpLocParts.slice(0, tmpLocParts.length - 1).join('/');
			}
			tmpHTML += '<div class="pict-fb-detail-row pict-fb-parent-row" onclick="navigateToPath(\'' + escapeHTML(tmpParentPath) + '\')">' +
				'<span class="pict-fb-detail-icon">' + SVGIcons['arrow-up'](16) + '</span>' +
				'<span class="pict-fb-detail-name">..</span>' +
				'<span class="pict-fb-detail-size"></span>' +
				'<span class="pict-fb-detail-modified"></span>' +
				'</div>';
		}

		if (tmpList.length === 0 && !AppState.currentLocation)
		{
			tmpHTML += '<div class="pict-fb-empty">This folder is empty</div>';
		}
		else if (tmpList.length === 0)
		{
			// Inside a subfolder but no files; the ".." row is already shown above
		}
		else
		{
			for (var j = 0; j < tmpList.length; j++)
			{
				var tmpEntry = tmpList[j];
				var tmpIsSelected = AppState.currentFile && AppState.currentFile.Name === tmpEntry.Name && AppState.currentFile.Path === tmpEntry.Path;
				tmpHTML += '<div class="pict-fb-detail-row' + (tmpIsSelected ? ' selected' : '') + '" ' +
					'onclick="selectEntry(' + j + ')" ondblclick="openEntry(' + j + ')">' +
					'<span class="pict-fb-detail-icon">' + getEntryIcon(tmpEntry) + '</span>' +
					'<span class="pict-fb-detail-name">' + escapeHTML(tmpEntry.Name) + '</span>' +
					'<span class="pict-fb-detail-size">' + (tmpEntry.Type === 'folder' ? '--' : formatFileSize(tmpEntry.Size)) + '</span>' +
					'<span class="pict-fb-detail-modified">' + formatDate(tmpEntry.Modified) + '</span>' +
					'</div>';
			}
		}

		tmpHTML += '</div>';
		tmpPane.innerHTML = tmpHTML;
		AppState._sortedList = tmpList;
	}

	function getSortedFileList()
	{
		var tmpList = AppState.fileList.slice();
		var tmpField = AppState.sortField;
		var tmpAsc = AppState.sortAscending;
		tmpList.sort(function(pA, pB)
		{
			var tmpAIsFolder = (pA.Type === 'folder') ? 0 : 1;
			var tmpBIsFolder = (pB.Type === 'folder') ? 0 : 1;
			if (tmpAIsFolder !== tmpBIsFolder) return tmpAIsFolder - tmpBIsFolder;
			var tmpValA = pA[tmpField];
			var tmpValB = pB[tmpField];
			if (tmpValA == null && tmpValB == null) return 0;
			if (tmpValA == null) return 1;
			if (tmpValB == null) return -1;
			var tmpResult = 0;
			if (typeof tmpValA === 'string') { tmpResult = tmpValA.localeCompare(tmpValB); }
			else { tmpResult = tmpValA < tmpValB ? -1 : (tmpValA > tmpValB ? 1 : 0); }
			return tmpAsc ? tmpResult : -tmpResult;
		});
		return tmpList;
	}

	// ---- File info rendering ----
	function renderFileInfo()
	{
		var tmpPane = document.getElementById('FB-ViewPane');
		if (!tmpPane) return;

		// Build a location bar for the view pane (helpful in layouts without a list pane)
		var tmpLocationHTML = '';
		if (!hasPaneRole('list'))
		{
			tmpLocationHTML = renderBreadcrumbHTML();
		}

		if (!AppState.currentFile)
		{
			tmpPane.innerHTML = tmpLocationHTML + '<div class="pict-fb-fileinfo-none">No file selected</div>';
			return;
		}

		var tmpFile = AppState.currentFile;
		tmpPane.innerHTML = tmpLocationHTML +
			'<div class="pict-fb-fileinfo">' +
				'<div class="pict-fb-fileinfo-title">' + escapeHTML(tmpFile.Name) + '</div>' +
				'<table class="pict-fb-fileinfo-table">' +
					'<tr><td class="pict-fb-fileinfo-label">Type</td><td class="pict-fb-fileinfo-value">' + getFileTypeDescription(tmpFile) + '</td></tr>' +
					'<tr><td class="pict-fb-fileinfo-label">Size</td><td class="pict-fb-fileinfo-value">' + formatFileSize(tmpFile.Size) + '</td></tr>' +
					'<tr><td class="pict-fb-fileinfo-label">Modified</td><td class="pict-fb-fileinfo-value">' + formatDate(tmpFile.Modified) + '</td></tr>' +
					'<tr><td class="pict-fb-fileinfo-label">Extension</td><td class="pict-fb-fileinfo-value">' + (tmpFile.Extension || '--') + '</td></tr>' +
					'<tr><td class="pict-fb-fileinfo-label">Path</td><td class="pict-fb-fileinfo-value">' + escapeHTML(tmpFile.Path || '--') + '</td></tr>' +
				'</table>' +
			'</div>';
	}

	// ---- Actions ----
	function navigateToPath(pPath)
	{
		AppState.currentLocation = pPath || '';
		AppState.currentFile = null;

		if (hasPaneRole('browse'))
		{
			// Always ensure root is expanded
			var tmpRootNode = getTreeNode('');
			tmpRootNode.expanded = true;
			if (!tmpRootNode.loaded) { loadChildren(''); }

			// Expand all ancestor nodes for the target path
			if (pPath)
			{
				var tmpParts = pPath.split('/');
				var tmpAccum = '';
				for (var i = 0; i < tmpParts.length; i++)
				{
					tmpAccum = tmpAccum ? (tmpAccum + '/' + tmpParts[i]) : tmpParts[i];
					var tmpNode = getTreeNode(tmpAccum);
					tmpNode.expanded = true;
					if (!tmpNode.loaded)
					{
						loadChildren(tmpAccum);
					}
				}
			}
		}

		loadFileList();
	}

	function selectFolder(pPath)
	{
		var tmpNode = getTreeNode(pPath);
		tmpNode.expanded = true;
		if (!tmpNode.loaded) { loadChildren(pPath); }
		navigateToPath(pPath);
	}

	function toggleTreeNode(pPath)
	{
		var tmpNode = getTreeNode(pPath);
		tmpNode.expanded = !tmpNode.expanded;
		if (tmpNode.expanded && !tmpNode.loaded)
		{
			loadChildren(pPath);
			return;
		}
		renderTree();
	}

	function selectEntry(pIndex)
	{
		var tmpList = AppState._sortedList || [];
		if (pIndex < 0 || pIndex >= tmpList.length) return;
		AppState.currentFile = tmpList[pIndex];
		if (hasPaneRole('list')) renderFileList();
		if (hasPaneRole('view')) renderFileInfo();
	}

	function openEntry(pIndex)
	{
		var tmpList = AppState._sortedList || [];
		if (pIndex < 0 || pIndex >= tmpList.length) return;
		var tmpEntry = tmpList[pIndex];
		if (tmpEntry.Type === 'folder')
		{
			var tmpNewPath = AppState.currentLocation ? (AppState.currentLocation + '/' + tmpEntry.Name) : tmpEntry.Name;
			selectFolder(tmpNewPath);
		}
		else
		{
			AppState.currentFile = tmpEntry;
			if (hasPaneRole('list')) renderFileList();
			if (hasPaneRole('view')) renderFileInfo();
		}
	}

	function sortBy(pField)
	{
		if (AppState.sortField === pField) { AppState.sortAscending = !AppState.sortAscending; }
		else { AppState.sortField = pField; AppState.sortAscending = true; }
		renderFileList();
	}

	function onSearchInput(pQuery)
	{
		if (AppState.searchTimer) clearTimeout(AppState.searchTimer);
		AppState.searchTimer = setTimeout(function() { performSearch(pQuery); }, 150);
	}

	function performSearch(pQuery)
	{
		var tmpContainer = document.getElementById('FB-SearchResults');
		if (!tmpContainer) return;
		if (!pQuery || pQuery.length < 1) { tmpContainer.innerHTML = ''; return; }
		var tmpQuery = pQuery.toLowerCase();
		var tmpAll = AppState.fileList;
		var tmpResults = [];
		for (var i = 0; i < tmpAll.length; i++)
		{
			if (tmpAll[i].Name && tmpAll[i].Name.toLowerCase().indexOf(tmpQuery) >= 0) { tmpResults.push(tmpAll[i]); }
		}
		if (tmpResults.length === 0) { tmpContainer.innerHTML = '<div class="pict-fb-empty">No results found</div>'; return; }
		var tmpHTML = '';
		for (var j = 0; j < tmpResults.length && j < 50; j++)
		{
			var tmpEntry = tmpResults[j];
			tmpHTML += '<div class="pict-fb-search-result" onclick="searchResultClick(' + j + ')">' +
				'<span class="pict-fb-search-result-icon">' + getEntryIcon(tmpEntry) + '</span>' +
				'<span class="pict-fb-search-result-name">' + escapeHTML(tmpEntry.Name) + '</span>' +
				'<span class="pict-fb-search-result-path">' + escapeHTML(tmpEntry.Path || '') + '</span>' +
				'</div>';
		}
		tmpContainer.innerHTML = tmpHTML;
		AppState._searchResults = tmpResults;
	}

	function searchResultClick(pIndex)
	{
		var tmpResults = AppState._searchResults || [];
		if (pIndex < 0 || pIndex >= tmpResults.length) return;
		var tmpEntry = tmpResults[pIndex];
		if (tmpEntry.Type === 'folder') { selectFolder(tmpEntry.Path || tmpEntry.Name); }
		else
		{
			AppState.currentFile = tmpEntry;
			if (hasPaneRole('list')) renderFileList();
			if (hasPaneRole('view')) renderFileInfo();
		}
	}

	// ---- Data loading ----
	function loadFileList()
	{
		apiGet('/list', { path: AppState.currentLocation }, function(pError, pData)
		{
			if (pError) { AppState.fileList = []; }
			else { AppState.fileList = Array.isArray(pData) ? pData : []; }
			if (hasPaneRole('list')) renderFileList();
			if (hasPaneRole('browse')) renderTree();
			if (hasPaneRole('view')) renderFileInfo();
		});
	}

	function loadChildren(pPath)
	{
		var tmpNode = getTreeNode(pPath);
		apiGet('/children', { path: pPath }, function(pError, pData)
		{
			if (pError) { tmpNode.children = []; tmpNode.loaded = true; tmpNode.hasChildren = false; }
			else { tmpNode.children = Array.isArray(pData) ? pData : []; tmpNode.loaded = true; tmpNode.hasChildren = tmpNode.children.length > 0; }
			if (hasPaneRole('browse')) renderTree();
		});
	}

	// ---- Boot ----
	// Set the header icon to SVG folder
	var tmpHeaderIcon = document.getElementById('App-Header-Icon');
	if (tmpHeaderIcon) { tmpHeaderIcon.innerHTML = SVGIcons['folder'](20); }

	renderLayoutSwitcher();
	renderLayout();

	// Load root children for the tree
	var tmpRootNode = getTreeNode('');
	tmpRootNode.expanded = true;
	loadChildren('');

	// Render initial pane content
	if (hasPaneRole('list')) renderFileList();
	if (hasPaneRole('view')) renderFileInfo();

	// Also load the file list
	loadFileList();
	</script>
</body>
</html>
